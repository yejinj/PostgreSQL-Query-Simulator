<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>쿼리 분석 결과 - PostgreSQL 분석기</title>
    
    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    
    <style>
        /* 탭 텍스트 가독성 개선 */
        .nav-tabs .nav-link {
            color: #212529 !important;
            font-weight: 600 !important;
            border: 2px solid #dee2e6;
            background-color: #f8f9fa;
        }
        
        .nav-tabs .nav-link.active {
            color: #212529 !important;
            background-color: #ffffff !important;
            border-color: #dee2e6 #dee2e6 #ffffff !important;
            font-weight: 700 !important;
        }
        
        .nav-tabs .nav-link:hover {
            color: #495057 !important;
            background-color: #e9ecef;
            border-color: #dee2e6;
        }
        
        /* 차트 제목 가독성 개선 */
        .chart-title {
            color: #212529 !important;
            font-weight: 700 !important;
            font-size: 1.1rem !important;
        }
        
        /* 지표 레이블 가독성 개선 */
        .metric-label {
            color: #495057 !important;
            font-weight: 600 !important;
        }
        
        /* 지표 텍스트 강제 스타일 */
        .col-lg-4 span, .col-lg-4 h6 {
            color: #000000 !important;
        }
        
        .col-lg-4 .badge {
            background-color: #343a40 !important;
            color: #ffffff !important;
        }
        
        .col-lg-4 .progress-bar {
            background-color: #343a40 !important;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-database me-2"></i>PostgreSQL 쿼리 분석기
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="/">
                        <i class="fas fa-plus-circle me-2"></i>새 분석
                    </a>
                    <a class="nav-link" href="/schema/browser">
                        <i class="fas fa-table me-2"></i>스키마 브라우저
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-12">
                
                <!-- 실행 결과 요약 -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>쿼리 실행 결과
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3 mb-2">
                                <div class="p-3 bg-primary bg-opacity-10 rounded">
                                    <h4 class="text-white mb-1" th:text="${#numbers.formatDecimal(result.actualTime, 1, 2)} + 'ms'">12.5ms</h4>
                                    <small class="text-muted">실행 시간</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="p-3 bg-success bg-opacity-10 rounded">
                                    <h4 class="text-success mb-1" th:text="${result.totalRows}">1,234</h4>
                                    <small class="text-muted">처리된 행</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="p-3 bg-info bg-opacity-10 rounded">
                                    <h4 class="text-info mb-1" th:text="${#numbers.formatDecimal(result.totalCost, 1, 2)}">45.67</h4>
                                    <small class="text-muted">총 비용</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <div class="p-3 bg-warning bg-opacity-10 rounded">
                                    <h4 class="text-warning mb-1" th:text="${#lists.size(result.optimizationSuggestions)}">2</h4>
                                    <small class="text-muted">개선 제안</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 성능 시각화 차트 -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>실행 시간별 성능 메트릭
                        </h6>
                    </div>
                    <div class="card-body">
                        <!-- 차트 탭 네비게이션 -->
                        <ul class="nav nav-tabs mb-3" id="chartTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active text-dark fw-bold" id="system-tab" data-bs-toggle="tab" data-bs-target="#system-metrics" type="button" role="tab">
                                    <i class="fas fa-microchip me-2"></i>시스템 리소스
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link text-dark fw-bold" id="database-tab" data-bs-toggle="tab" data-bs-target="#database-metrics" type="button" role="tab">
                                    <i class="fas fa-database me-2"></i>데이터베이스 성능
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="chartTabContent">
                            <!-- 시스템 리소스 차트 -->
                            <div class="tab-pane fade show active" id="system-metrics" role="tabpanel">
                                <div class="row">
                                    <div class="col-lg-8">
                                        <canvas id="systemChart" height="300"></canvas>
                                    </div>
                                    <div class="col-lg-4">
                                        <h6 class="mb-3 fw-bold" style="color: #333;">
                                            <i class="fas fa-info-circle me-2" style="color: #666;"></i>시스템 리소스 지표
                                        </h6>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="small fw-semibold" style="color: #333;">현재 CPU 사용률</span>
                                                <span class="badge bg-dark" id="currentCpu">98%</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 4px;">
                                                <div class="progress-bar bg-dark" id="cpuProgress" style="width: 98%"></div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="small fw-semibold" style="color: #333;">현재 메모리 사용률</span>
                                                <span class="badge bg-dark" id="currentMemory">94%</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 4px;">
                                                <div class="progress-bar bg-dark" id="memoryProgress" style="width: 94%"></div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="small fw-semibold" style="color: #333;">현재 I/O 대기시간</span>
                                                <span class="badge bg-dark" id="currentIo">150ms</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 데이터베이스 성능 차트 -->
                            <div class="tab-pane fade" id="database-metrics" role="tabpanel">
                                <div class="row">
                                    <div class="col-lg-8">
                                        <canvas id="databaseChart" height="300"></canvas>
                                    </div>
                                    <div class="col-lg-4">
                                        <h6 class="mb-3 fw-bold" style="color: #333;">
                                            <i class="fas fa-chart-line me-2" style="color: #666;"></i>데이터베이스 지표
                                        </h6>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="small fw-semibold" style="color: #333;">현재 TPS</span>
                                                <span class="badge bg-dark" id="currentTps">1,500</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="small fw-semibold" style="color: #333;">활성 세션 수</span>
                                                <span class="badge bg-dark" id="currentSessions">95</span>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="small fw-semibold" style="color: #333;">캐시 히트율</span>
                                                <span class="badge bg-dark" id="currentCacheHit">8%</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 4px;">
                                                <div class="progress-bar bg-dark" id="cacheHitProgress" style="width: 8%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        

                    </div>
                </div>

                        <!-- 분석된 쿼리 -->
                <div class="card mb-4">
                    <div class="card-header bg-light border-bottom">
                        <h6 class="mb-0 text-dark">
                            <i class="fas fa-code me-2 text-secondary"></i>분석된 쿼리
                                </h6>
                            </div>
                    <div class="card-body p-4">
                        <pre class="bg-light p-3 rounded mb-0" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6;"><code th:text="${result.originalQuery}"></code></pre>
                            </div>
                        </div>

                <!-- AI 기반 병목 분석 -->
                <div class="card mb-4" th:if="${result.aiBottleneckAnalyses != null and !result.aiBottleneckAnalyses.isEmpty()}">
                    <div class="card-header bg-light border-bottom">
                        <h6 class="mb-0 text-dark">
                            <i class="fas fa-robot me-2 text-secondary"></i>AI 병목 분석
                            <small class="text-muted ms-2">지능형 성능 진단</small>
                        </h6>
                    </div>
                    <div class="card-body p-4">
                        <div th:each="analysis, iterStat : ${result.aiBottleneckAnalyses}" 
                             class="border rounded p-4 mb-3"
                             th:classappend="${analysis.severityLevel == 'CRITICAL' or analysis.severityLevel == '심각'} ? 'border-secondary bg-light' : 
                                           (${analysis.severityLevel == 'HIGH' or analysis.severityLevel == '높음'} ? 'border-secondary bg-light' : 
                                           'border-secondary bg-light')"
                             style="border-color: #dee2e6 !important; background-color: #f8f9fa !important;">
                            
                            <!-- 병목 유형 -->
                            <div class="d-flex align-items-start mb-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-exclamation-triangle me-2 text-secondary"></i>
                                    <h6 class="mb-0 text-dark fw-semibold" th:text="${analysis.bottleneckType}">전체 테이블 스캔</h6>
                                </div>
                            </div>
                            
                            <!-- 상세 설명 -->
                            <div class="mb-3">
                                <p class="mb-0 text-dark" style="line-height: 1.6;" th:text="${analysis.detailedDescription}">
                                    테이블 'users'에서 전체 테이블 스캔이 발생하고 있습니다. 실행 시간: 245.2ms, 비용: 1250
                                </p>
                            </div>
                            
                            <!-- 권장사항 -->
                            <div class="mb-3">
                                <h6 class="text-secondary mb-2">
                                    <i class="fas fa-lightbulb me-1"></i>개선 방안
                                </h6>
                                <p class="mb-0 text-muted" style="line-height: 1.6;" th:text="${analysis.recommendation}">
                                    WHERE 절의 컬럼에 인덱스를 생성하여 검색 성능을 개선하세요.
                                </p>
                            </div>
                            
                            <!-- 성능 패턴 분석 -->
                            <div class="mb-3">
                                <h6 class="text-secondary mb-2">
                                    <i class="fas fa-chart-line me-1"></i>성능 패턴 분석
                                </h6>
                                <div class="bg-white border rounded p-3" style="border-color: #dee2e6;">
                                    <!-- 병목 시점 정보 -->
                                    <div th:if="${analysis.affectedTables != null and #strings.startsWith(analysis.affectedTables, '병목 시점:')}" class="mb-2">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-exclamation-circle text-secondary me-2"></i>
                                            <strong class="text-dark">그래프 병목 지점</strong>
                                        </div>
                                        <p class="mb-2 text-muted small" th:text="${analysis.affectedTables}">병목 시점: 0.2ms, 0.5ms</p>
                                        <p class="mb-0 text-muted small">이 시점들에서 CPU/메모리/I/O 리소스가 급격히 증가하여 성능 저하가 발생했습니다.</p>
                                    </div>
                                    
                                    <!-- 병목 포인트 상세 분석 -->
                                    <div th:if="${result.bottleneckPoints != null and !result.bottleneckPoints.isEmpty()}">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-search text-secondary me-2"></i>
                                            <strong class="text-dark">상세 병목 분석</strong>
                                        </div>
                                        <div th:each="point, pointStat : ${result.bottleneckPoints}" 
                                             th:if="${pointStat.index < 3}"
                                             class="mb-2 p-2 bg-light rounded" style="border-left: 3px solid #6c757d;">
                                            <div class="d-flex justify-content-between align-items-start mb-1">
                                                <span class="badge bg-dark small" style="color: #333; background-color: #f8f9fa !important; border: 1px solid #dee2e6;" th:text="'시점 ' + ${#numbers.formatDecimal(point.timestamp, 1, 1)} + 'ms'">시점 0.2ms</span>
                                            </div>
                                            <p class="mb-1 small text-dark" th:text="${point.description}">CPU 사용률이 급증하여 성능 저하가 발생했습니다.</p>
                                            <p class="mb-0 text-muted" style="font-size: 0.8rem;" th:text="'유형: ' + ${point.bottleneckType}">유형: CPU</p>
                                        </div>
                                    </div>
                                    
                                    <!-- 패턴 분석 결론 -->
                                    <div class="mt-2 p-2 bg-light rounded">
                                        <div class="d-flex align-items-center mb-1">
                                            <i class="fas fa-chart-bar text-secondary me-2"></i>
                                            <strong class="text-dark small">패턴 요약</strong>
                                        </div>
                                        <p class="mb-0 text-muted small">
                                            감지된 병목 지점들을 종합하면, 주로 
                                            <span th:if="${result.bottleneckPoints != null and !result.bottleneckPoints.isEmpty()}" 
                                                  th:text="${result.bottleneckPoints[0].bottleneckType}">CPU</span> 
                                            리소스에서 문제가 발생하고 있으며, 쿼리 최적화를 통해 성능을 개선할 수 있습니다.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                            
                            <!-- AI 최적화 SQL -->
                            <div th:if="${result.optimizedQuery != null and !#strings.isEmpty(result.optimizedQuery)}">
                                <h6 class="text-secondary mb-2">
                                    <i class="fas fa-magic me-1"></i>AI 최적화 SQL
                                </h6>
                                <pre class="bg-white p-3 rounded mb-3" style="max-height: 250px; overflow-y: auto; border: 1px solid #dee2e6; font-size: 0.85rem;"><code th:text="${result.optimizedQuery}"></code></pre>
                                <div class="text-center">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard(this.previousElementSibling.previousElementSibling.textContent)">
                                        <i class="fas fa-copy me-1"></i>최적화 SQL 복사
                                    </button>
                                </div>
                                </div>
                        

                            

                            
                            <!-- 기존 테이블/컬럼 정보 (병목 시점이 아닌 경우) -->
                            <div th:if="${analysis.affectedTables != null and !#strings.startsWith(analysis.affectedTables, '병목 시점:')}" class="row text-center mt-2">
                                <div class="col-6" th:if="${analysis.affectedTables != null}">
                                    <small class="text-muted d-block">대상 테이블</small>
                                    <strong class="text-info" th:text="${analysis.affectedTables}">users</strong>
                            </div>
                                <div class="col-6" th:if="${analysis.affectedColumns != null}">
                                    <small class="text-muted d-block">대상 컬럼</small>
                                    <strong class="text-info" th:text="${analysis.affectedColumns}">email</strong>
                        </div>
                            </div>
                        </div>
                        

                    </div>
                </div>

                <!-- 실행 계획 -->
                <div class="card mb-4">
                    <div class="card-header bg-light border-bottom">
                        <h6 class="mb-0 text-dark">
                            <i class="fas fa-sitemap me-2 text-secondary"></i>실행 계획
                        </h6>
                    </div>
                    <div class="card-body p-4">
                        <pre class="bg-light p-3 rounded mb-0" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6;"><code th:text="${result.executionPlan}"></code></pre>
                    </div>
                </div>

                <!-- 쿼리 결과 -->
                <div class="card mb-4" th:if="${result.queryResult != null}">
                    <div class="card-header bg-light border-bottom">
                        <h6 class="mb-0 text-dark">
                            <i class="fas fa-table me-2 text-secondary"></i>쿼리 결과
                        </h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark sticky-top">
                                    <tr th:if="${result.queryResult.size() > 0}">
                                        <th th:each="column : ${result.queryResult[0].keySet()}" class="py-2 px-3">
                                            <small th:text="${column}"></small>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="row : ${result.queryResult}">
                                        <td th:each="column : ${row.keySet()}" class="py-2 px-3">
                                            <span th:if="${row[column] != null}" 
                                                  class="small" th:text="${row[column]}"></span>
                                            <span th:if="${row[column] == null}" 
                                                  class="text-muted small fst-italic">NULL</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>



                <!-- 액션 버튼 -->
                <div class="text-center">
                    <a href="/" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>새로운 쿼리 분석
                    </a>
                    <a href="/schema/browser" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-table me-2"></i>스키마 브라우저
                    </a>
                </div>

            </div>
        </div>
    </div>

    <!-- 기존 performanceChart는 숨김 (하위 호환성을 위해 유지) -->
    <canvas id="performanceChart" height="300" style="display: none;"></canvas>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 시간별 성능 메트릭 차트 생성
        let timePoints = /*[[${result.timeSeriesMetrics != null ? result.timeSeriesMetrics.timePoints : null}]]*/ [];
        let bottleneckPoints = /*[[${result.bottleneckPoints}]]*/ [];
        let realMetrics = null;
        
        // 실제 PostgreSQL 메트릭 로드
        async function loadRealDatabaseMetrics() {
            try {
                const response = await fetch('/api/database-metrics');
                const metrics = await response.json();
                realMetrics = metrics;
                console.log('실제 DB 메트릭 로드됨:', metrics);
                
                // 실제 데이터로 차트 업데이트
                updateChartsWithRealData(metrics);
                updateMetricDisplays(metrics);
                
            } catch (error) {
                console.error('실제 DB 메트릭 로드 실패:', error);
                // 실패 시 더미 데이터 사용
                generateDummyData();
            }
        }
        
        // 실제 데이터로 차트 업데이트
        function updateChartsWithRealData(metrics) {
            // 실제 메트릭을 시계열 형태로 변환 (더 상세한 시계열 생성)
            const baseIoWait = extractIOWaitTime(metrics.ioStats);
            const baseTps = metrics.tps || 0;
            const baseSessions = metrics.activeConnections || 0;
            const baseCacheHit = metrics.cacheHitRate || 0;
            
            // 10개 시점으로 상세한 시계열 생성 (패턴 시뮬레이션)
            timePoints = [];
            for (let i = 0; i < 10; i++) {
                const progress = i / 9; // 0 ~ 1
                
                // 자연스러운 변화 패턴 생성
                const variation = Math.sin(progress * Math.PI * 2) * 0.3 + 0.1;
                const trendFactor = 1 + progress * 0.5; // 점진적 증가
                
                timePoints.push({
                    timestamp: i * 2.5, // 0ms, 2.5ms, 5ms, ... 22.5ms
                    cpuUsage: Math.max(5, Math.min(98, Math.round(15 + progress * 80 + variation * 25))),
                    memoryUsage: Math.max(8, Math.min(95, Math.round(12 + progress * 75 + variation * 20))),
                    ioWaitTime: Math.max(1, Math.round(baseIoWait * (1 + variation * 0.8) * trendFactor)),
                    tps: Math.max(1, Math.round(baseTps * (1 + variation) * trendFactor)),
                    activeSessions: Math.max(1, Math.round(baseSessions * (1 + variation * 0.6) * trendFactor)),
                    cacheHitRate: Math.max(10, Math.min(100, baseCacheHit * (1 - variation * 0.2)))
                });
            }
            
            console.log('상세한 시계열 데이터로 timePoints 업데이트:', timePoints);
            
            // 최고치 시점 분석 및 병목 포인트 생성
            generateBottleneckPointsFromPeaks();
            
            redrawCharts();
        }
        
        // I/O 대기시간 추출 (블록 읽기 비율로 추정)
        function extractIOWaitTime(ioStats) {
            if (!ioStats || !ioStats.blocks_read || !ioStats.blocks_hit) return 1;
            
            const totalBlocks = parseInt(ioStats.blocks_read) + parseInt(ioStats.blocks_hit);
            const readRatio = parseInt(ioStats.blocks_read) / totalBlocks;
            
            // 읽기 비율이 높을수록 I/O 대기시간이 높다고 가정
            return Math.round(readRatio * 100 + 1);
        }
        
        // 메트릭 표시 업데이트
        function updateMetricDisplays(metrics) {
            // I/O 대기시간
            const ioElement = document.getElementById('currentIo');
            if (ioElement) {
                ioElement.textContent = extractIOWaitTime(metrics.ioStats) + 'ms';
            }
            
            // TPS
            const tpsElement = document.getElementById('currentTps');
            if (tpsElement) {
                tpsElement.textContent = Math.round(metrics.tps || 0).toLocaleString();
            }
            
            // 활성 세션
            const sessionsElement = document.getElementById('currentSessions');
            if (sessionsElement) {
                sessionsElement.textContent = metrics.activeConnections || 0;
            }
            
            // 캐시 히트율
            const cacheElement = document.getElementById('currentCacheHit');
            const cacheProgressElement = document.getElementById('cacheHitProgress');
            if (cacheElement && cacheProgressElement) {
                const hitRate = Math.round(metrics.cacheHitRate || 0);
                cacheElement.textContent = hitRate + '%';
                cacheProgressElement.style.width = hitRate + '%';
            }
        }
        
        // 더미 데이터 생성 (백업용) - 더 상세한 패턴
        function generateDummyData() {
            console.log('상세한 더미 데이터 생성 중...');
            timePoints = [
                { timestamp: 0.0, cpuUsage: 15, memoryUsage: 12, ioWaitTime: 2, tps: 95, activeSessions: 1, cacheHitRate: 97 },
                { timestamp: 2.5, cpuUsage: 22, memoryUsage: 18, ioWaitTime: 3, tps: 120, activeSessions: 2, cacheHitRate: 95 },
                { timestamp: 5.0, cpuUsage: 35, memoryUsage: 28, ioWaitTime: 5, tps: 180, activeSessions: 3, cacheHitRate: 92 },
                { timestamp: 7.5, cpuUsage: 48, memoryUsage: 42, ioWaitTime: 8, tps: 250, activeSessions: 5, cacheHitRate: 88 },
                { timestamp: 10.0, cpuUsage: 62, memoryUsage: 55, ioWaitTime: 15, tps: 380, activeSessions: 8, cacheHitRate: 82 },
                { timestamp: 12.5, cpuUsage: 75, memoryUsage: 68, ioWaitTime: 25, tps: 520, activeSessions: 12, cacheHitRate: 75 },
                { timestamp: 15.0, cpuUsage: 84, memoryUsage: 78, ioWaitTime: 42, tps: 720, activeSessions: 18, cacheHitRate: 65 },
                { timestamp: 17.5, cpuUsage: 91, memoryUsage: 85, ioWaitTime: 68, tps: 980, activeSessions: 28, cacheHitRate: 52 },
                { timestamp: 20.0, cpuUsage: 95, memoryUsage: 89, ioWaitTime: 95, tps: 1280, activeSessions: 42, cacheHitRate: 38 },
                { timestamp: 22.5, cpuUsage: 97, memoryUsage: 92, ioWaitTime: 125, tps: 1620, activeSessions: 58, cacheHitRate: 25 },
                { timestamp: 25.0, cpuUsage: 98, memoryUsage: 94, ioWaitTime: 150, tps: 1950, activeSessions: 75, cacheHitRate: 15 }
            ];
            
            // 최고치 시점 분석 및 병목 포인트 생성
            generateBottleneckPointsFromPeaks();
            
            redrawCharts();
        }
        
        // 최고치 시점 기반 병목 포인트 생성
        function generateBottleneckPointsFromPeaks() {
            if (!timePoints || timePoints.length === 0) return;
            
            console.log('=== 최고치 시점 분석 시작 ===');
            
            // 각 지표의 최고치 시점 찾기
            let maxCpu = { value: 0, index: 0, timestamp: 0 };
            let maxMemory = { value: 0, index: 0, timestamp: 0 };
            let maxTps = { value: 0, index: 0, timestamp: 0 };
            let maxIoWait = { value: 0, index: 0, timestamp: 0 };
            let maxSessions = { value: 0, index: 0, timestamp: 0 };
            let minCacheHit = { value: 100, index: 0, timestamp: 0 };
            
            timePoints.forEach((point, index) => {
                // CPU 사용률 최고치
                if (point.cpuUsage > maxCpu.value) {
                    maxCpu = { value: point.cpuUsage, index: index, timestamp: point.timestamp };
                }
                
                // 메모리 사용률 최고치
                if (point.memoryUsage > maxMemory.value) {
                    maxMemory = { value: point.memoryUsage, index: index, timestamp: point.timestamp };
                }
                
                // TPS 최고치
                if (point.tps > maxTps.value) {
                    maxTps = { value: point.tps, index: index, timestamp: point.timestamp };
                }
                
                // I/O 대기시간 최고치
                if (point.ioWaitTime > maxIoWait.value) {
                    maxIoWait = { value: point.ioWaitTime, index: index, timestamp: point.timestamp };
                }
                
                // 활성 세션 최고치
                if (point.activeSessions > maxSessions.value) {
                    maxSessions = { value: point.activeSessions, index: index, timestamp: point.timestamp };
                }
                
                // 캐시 히트율 최저치 (성능 저하 지점)
                if (point.cacheHitRate < minCacheHit.value) {
                    minCacheHit = { value: point.cacheHitRate, index: index, timestamp: point.timestamp };
                }
            });
            
            console.log('분석된 최고치 시점들:', {
                maxCpu: maxCpu,
                maxMemory: maxMemory,
                maxTps: maxTps,
                maxIoWait: maxIoWait,
                maxSessions: maxSessions,
                minCacheHit: minCacheHit
            });
            
            // 병목 포인트 생성 (중복 제거)
            const peaks = new Map();
            
            // CPU 병목 지점
            if (maxCpu.value > 80) {
                peaks.set(maxCpu.timestamp, {
                    timestamp: maxCpu.timestamp,
                    bottleneckType: 'CPU_OVERLOAD',
                    severity: maxCpu.value,
                    description: `CPU 사용률이 ${maxCpu.value}%에 도달했습니다. 복잡한 연산이나 비효율적인 쿼리로 인한 CPU 병목이 발생했습니다.`
                });
            }
            
            // 메모리 병목 지점
            if (maxMemory.value > 75) {
                peaks.set(maxMemory.timestamp, {
                    timestamp: maxMemory.timestamp,
                    bottleneckType: 'MEMORY_PRESSURE',
                    severity: maxMemory.value,
                    description: `메모리 사용률이 ${maxMemory.value}%에 도달했습니다. 대용량 데이터 처리나 메모리 누수로 인한 메모리 부족이 예상됩니다.`
                });
            }
            
            // TPS 급증 지점
            if (maxTps.value > 100) {
                peaks.set(maxTps.timestamp, {
                    timestamp: maxTps.timestamp,
                    bottleneckType: 'TPS_SPIKE',
                    severity: Math.min(100, maxTps.value / 10),
                    description: `TPS가 ${maxTps.value}에 도달하여 데이터베이스 처리량이 급증했습니다. 동시 접속자 증가로 인한 부하가 예상됩니다.`
                });
            }
            
            // I/O 병목 지점
            if (maxIoWait.value > 10) {
                peaks.set(maxIoWait.timestamp, {
                    timestamp: maxIoWait.timestamp,
                    bottleneckType: 'IO_BOTTLENECK',
                    severity: Math.min(100, maxIoWait.value),
                    description: `I/O 대기시간이 ${maxIoWait.value}ms로 급증했습니다. 디스크 읽기/쓰기 작업이 병목을 일으키고 있습니다.`
                });
            }
            
            // 세션 병목 지점
            if (maxSessions.value > 10) {
                peaks.set(maxSessions.timestamp, {
                    timestamp: maxSessions.timestamp,
                    bottleneckType: 'SESSION_OVERLOAD',
                    severity: Math.min(100, maxSessions.value * 2),
                    description: `활성 세션이 ${maxSessions.value}개로 증가했습니다. 동시 연결 수 증가로 인한 리소스 경합이 발생했습니다.`
                });
            }
            
            // 캐시 성능 저하 지점
            if (minCacheHit.value < 80) {
                peaks.set(minCacheHit.timestamp, {
                    timestamp: minCacheHit.timestamp,
                    bottleneckType: 'CACHE_MISS',
                    severity: Math.min(100, 100 - minCacheHit.value),
                    description: `캐시 히트율이 ${minCacheHit.value}%로 저하되었습니다. 메모리 부족 또는 비효율적인 쿼리 패턴이 원인입니다.`
                });
            }
            
            // 전역 병목 포인트 배열 업데이트
            bottleneckPoints = Array.from(peaks.values());
            
            console.log('생성된 병목 포인트들:', bottleneckPoints);
        }
        
        // 데이터가 없으면 실제 데이터 로드 시도, 실패 시 더미 데이터 사용
        if (!timePoints || timePoints.length === 0) {
            loadRealDatabaseMetrics();
        } else {
            // 기존 분석 결과가 있으면 그대로 사용
            console.log('기존 분석 결과 사용:', timePoints);
        }
        
        // 차트 데이터 준비
        const labels = timePoints.map(point => (point.timestamp || 0).toFixed(1) + 'ms');
        const cpuData = timePoints.map(point => point.cpuUsage || 0);
        const ioData = timePoints.map(point => point.ioWaitTime || 0);
        const memoryData = timePoints.map(point => point.memoryUsage || 0);
        const tpsData = timePoints.map(point => point.tps || 0);
        const sessionsData = timePoints.map(point => point.activeSessions || 0);
        const cacheHitData = timePoints.map(point => point.cacheHitRate || 100);
        
        console.log('차트 데이터:', { labels, cpuData, ioData, memoryData, tpsData, sessionsData, cacheHitData });
        
        // 시스템 리소스 차트 (I/O 대기시간만 표시)
        const systemCtx = document.getElementById('systemChart').getContext('2d');
        const systemChart = new Chart(systemCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'CPU 사용률 (%)',
                        data: cpuData,
                        borderColor: '#111827',
                        backgroundColor: 'rgba(17, 24, 39, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#111827',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        yAxisID: 'y'
                    },
                    {
                        label: '메모리 사용률 (%)',
                        data: memoryData,
                        borderColor: '#4b5563',
                        backgroundColor: 'rgba(75, 85, 99, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#4b5563',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        borderDash: [8, 4],
                        yAxisID: 'y'
                    },
                    {
                        label: 'I/O 대기시간 (ms)',
                        data: ioData,
                        borderColor: '#9ca3af',
                        backgroundColor: 'rgba(156, 163, 175, 0.15)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#9ca3af',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                                    plugins: {
                        title: {
                            display: true,
                            text: '시스템 리소스 사용률 급증 패턴',
                            font: { size: 18, weight: 'bold' },
                            color: '#212529'
                        },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '시간 (ms)',
                            font: { weight: 'bold', size: 14 },
                            color: '#212529'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: '사용률 (%)',
                            font: { weight: 'bold', size: 14 },
                            color: '#212529'
                        },
                        min: 0,
                        max: 100
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'I/O 대기시간 (ms)',
                            font: { weight: 'bold', size: 14 },
                            color: '#212529'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        min: 0
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });

        // 데이터베이스 성능 차트 (TPS, 활성 세션, 캐시 히트율) - 무채색 디자인
        const databaseCtx = document.getElementById('databaseChart').getContext('2d');
        const databaseChart = new Chart(databaseCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'TPS (초당 트랜잭션)',
                        data: tpsData,
                        borderColor: '#1f2937',
                        backgroundColor: 'rgba(31, 41, 55, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1',
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#1f2937',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    },
                    {
                        label: '활성 세션 수',
                        data: sessionsData,
                        borderColor: '#6b7280',
                        backgroundColor: 'rgba(107, 114, 128, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y2',
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#6b7280',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        borderDash: [5, 5]
                    },
                    {
                        label: '캐시 히트율 (%)',
                        data: cacheHitData,
                        borderColor: '#9ca3af',
                        backgroundColor: 'rgba(156, 163, 175, 0.15)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#9ca3af',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                                    plugins: {
                        title: {
                            display: true,
                            text: '데이터베이스 성능 메트릭 변화',
                            font: { size: 18, weight: 'bold' },
                            color: '#212529'
                        },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '시간 (ms)',
                            font: { weight: 'bold', size: 14 },
                            color: '#212529'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: '캐시 히트율 (%)',
                            font: { weight: 'bold', size: 14 },
                            color: '#212529'
                        },
                        min: 0,
                        max: 100
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'TPS',
                            font: { weight: 'bold', size: 14 },
                            color: '#212529'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        min: 0
                    },
                    y2: {
                        type: 'linear',
                        display: false,
                        min: 0
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });

        // 기존 performanceChart는 유지 (숨김 상태)
        const ctx = document.getElementById('performanceChart').getContext('2d');
        const performanceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'CPU 사용률 (%)',
                        data: cpuData,
                        borderColor: '#6b7280',
                        backgroundColor: 'rgba(107, 114, 128, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    },
                    {
                        label: 'I/O 대기시간 (ms)',
                        data: ioData,
                        borderColor: '#9ca3af',
                        backgroundColor: 'rgba(156, 163, 175, 0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '쿼리 실행 시간별 성능 메트릭'
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '시간 (ms)'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'CPU 사용률 (%)'
                        },
                        min: 0,
                        max: 100
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'I/O 대기시간 (ms)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        min: 0
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });

        // 현재 값들을 최신 데이터로 업데이트
        const latestPoint = timePoints[timePoints.length - 1];
        if (latestPoint) {
            // 시스템 리소스 지표 업데이트
            document.getElementById('currentCpu').textContent = Math.round(latestPoint.cpuUsage || 0) + '%';
            document.getElementById('cpuProgress').style.width = (latestPoint.cpuUsage || 0) + '%';
            
            document.getElementById('currentMemory').textContent = Math.round(latestPoint.memoryUsage || 0) + '%';
            document.getElementById('memoryProgress').style.width = (latestPoint.memoryUsage || 0) + '%';
            
            document.getElementById('currentIo').textContent = Math.round(latestPoint.ioWaitTime || 0) + 'ms';
            
            // 데이터베이스 지표 업데이트
            document.getElementById('currentTps').textContent = (latestPoint.tps || 0).toLocaleString();
            document.getElementById('currentSessions').textContent = latestPoint.activeSessions || 0;
            
            document.getElementById('currentCacheHit').textContent = Math.round(latestPoint.cacheHitRate || 0) + '%';
            document.getElementById('cacheHitProgress').style.width = (latestPoint.cacheHitRate || 0) + '%';
            
            // 모든 배지를 무채색으로 통일
            const cpuBadge = document.getElementById('currentCpu');
            const memoryBadge = document.getElementById('currentMemory');
            const ioBadge = document.getElementById('currentIo');
            const cacheHitBadge = document.getElementById('currentCacheHit');
            
            cpuBadge.className = 'badge bg-dark';
            memoryBadge.className = 'badge bg-dark';
            ioBadge.className = 'badge bg-dark';
            cacheHitBadge.className = 'badge bg-dark';
        }

        // 병목 지점 자동 감지 및 생성 (데이터가 없을 때)
        if (!bottleneckPoints || bottleneckPoints.length === 0) {
            bottleneckPoints = [];
            
            // I/O 급증 지점 감지
            for (let i = 1; i < timePoints.length; i++) {
                const prev = timePoints[i - 1];
                const curr = timePoints[i];
                
                // I/O 대기시간이 20ms 이상 급증한 경우
                if (curr.ioWaitTime - prev.ioWaitTime >= 20) {
                    bottleneckPoints.push({
                        timestamp: curr.timestamp,
                        bottleneckType: 'IO',
                        severity: Math.min(100, curr.ioWaitTime),
                        description: `I/O 대기시간이 ${Math.round(prev.ioWaitTime)}ms에서 ${Math.round(curr.ioWaitTime)}ms로 급증했습니다.`
                    });
                }
            }
        }

        // 병목 지점을 차트에 표시
        function addBottleneckAnnotations(chart, chartName) {
            if (bottleneckPoints && bottleneckPoints.length > 0) {
                bottleneckPoints.forEach((bottleneck, index) => {
                    const timestampIndex = timePoints.findIndex(point => 
                        Math.abs((point.timestamp || 0) - (bottleneck.timestamp || 0)) < 0.1
                    );
                    
                    if (timestampIndex !== -1) {
                        // 차트에 수직선 주석 추가 (annotation 플러그인이 있다면)
                        console.log(`${chartName}에서 ${bottleneck.bottleneckType} 병목 지점 감지: ${bottleneck.timestamp}ms`);
                    }
                });
            }
        }
        
        addBottleneckAnnotations(systemChart, '시스템 차트');
        addBottleneckAnnotations(databaseChart, '데이터베이스 차트');
        
        // 차트 다시 그리기
        function redrawCharts() {
            // 새로운 데이터로 차트 업데이트
            const labels = timePoints.map(point => (point.timestamp || 0).toFixed(1) + 'ms');
            const cpuData = timePoints.map(point => point.cpuUsage || 0);
            const memoryData = timePoints.map(point => point.memoryUsage || 0);
            const ioData = timePoints.map(point => point.ioWaitTime || 0);
            const tpsData = timePoints.map(point => point.tps || 0);
            const sessionsData = timePoints.map(point => point.activeSessions || 0);
            const cacheHitData = timePoints.map(point => point.cacheHitRate || 100);
            
            console.log('차트 업데이트 - 데이터 포인트 수:', labels.length);
            console.log('CPU 범위:', Math.min(...cpuData), '~', Math.max(...cpuData));
            console.log('메모리 범위:', Math.min(...memoryData), '~', Math.max(...memoryData));
            console.log('TPS 범위:', Math.min(...tpsData), '~', Math.max(...tpsData));
            console.log('I/O 범위:', Math.min(...ioData), '~', Math.max(...ioData));
            console.log('캐시 히트율 범위:', Math.min(...cacheHitData), '~', Math.max(...cacheHitData));
            
            // 시스템 차트 업데이트 (CPU, 메모리, I/O)
            if (window.systemChart) {
                systemChart.data.labels = labels;
                systemChart.data.datasets[0].data = cpuData;      // CPU 사용률
                systemChart.data.datasets[1].data = memoryData;   // 메모리 사용률
                systemChart.data.datasets[2].data = ioData;       // I/O 대기시간
                systemChart.update('none'); // 애니메이션 없이 빠른 업데이트
            }
            
            // 데이터베이스 차트 업데이트 (올바른 순서로)
            if (window.databaseChart) {
                databaseChart.data.labels = labels;
                databaseChart.data.datasets[0].data = tpsData;        // TPS
                databaseChart.data.datasets[1].data = sessionsData;   // 활성 세션
                databaseChart.data.datasets[2].data = cacheHitData;   // 캐시 히트율
                databaseChart.update('none'); // 애니메이션 없이 빠른 업데이트
            }
        }

        // SQL 복사 함수
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text.trim()).then(function() {
                // 버튼 텍스트 일시 변경
                const button = event.target.closest('button');
                const originalHTML = button.innerHTML;
                const originalClasses = button.className;
                
                button.innerHTML = '<i class="fas fa-check me-1"></i>복사됨!';
                button.className = 'btn btn-success btn-sm';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.className = originalClasses;
                }, 2000);
            }).catch(function(err) {
                console.error('복사 실패:', err);
                alert('클립보드 복사에 실패했습니다.');
            });
        }
        
        // 차트 객체를 전역으로 설정
        window.systemChart = systemChart;
        window.databaseChart = databaseChart;
    </script>
</body>
</html> 