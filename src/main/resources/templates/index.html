<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB Resource Simulator - PostgreSQL 쿼리 비용 분석</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism.min.css" rel="stylesheet">
    <style>
        .query-container {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }
        .result-container {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            background-color: white;
        }
        .cost-card {
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
        }
        .suggestion-item {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
        }
        .loading {
            display: none;
        }
        .node-analysis {
            margin-left: 20px;
            padding: 10px;
            border-left: 2px solid #6c757d;
            margin-bottom: 10px;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <header class="bg-primary text-white p-3 mb-4">
            <div class="container">
                <h1>DB Resource Simulator</h1>
                <p class="mb-0">PostgreSQL 쿼리 성능 분석 및 비용 계산</p>
            </div>
        </header>

        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="query-container">
                        <h3>SQL 쿼리 입력</h3>
                        <form id="queryForm">
                            <div class="mb-3">
                                <label for="sqlQuery" class="form-label">SQL 쿼리</label>
                                <textarea class="form-control" id="sqlQuery" rows="8" 
                                    placeholder="분석할 PostgreSQL 쿼리를 입력하세요...
예시:
SELECT u.username, COUNT(o.id) as order_count 
FROM users u 
LEFT JOIN orders o ON u.id = o.user_id 
WHERE u.created_at > '2023-01-01' 
GROUP BY u.id, u.username 
ORDER BY order_count DESC 
LIMIT 10;"></textarea>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button type="submit" class="btn btn-primary">
                                    <span class="spinner-border spinner-border-sm loading me-2" role="status"></span>
                                    쿼리 분석 실행
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearResults()">결과 초기화</button>
                            </div>
                        </form>
                    </div>

                    <div id="resultContainer" class="result-container" style="display: none;">
                        <h3>분석 결과</h3>
                        
                        <!-- 비용 정보 -->
                        <div id="costSection">
                            <h4>리소스 비용 분석</h4>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="cost-card">
                                        <h6>CPU 비용</h6>
                                        <h5 id="cpuCost">$0.000000</h5>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="cost-card">
                                        <h6>I/O 비용</h6>
                                        <h5 id="ioCost">$0.000000</h5>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="cost-card">
                                        <h6>메모리 비용</h6>
                                        <h5 id="memoryCost">$0.000000</h5>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="cost-card">
                                        <h6>총 비용</h6>
                                        <h5 id="totalCost">$0.000000</h5>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 실행 정보 -->
                        <div id="executionSection" class="mt-4">
                            <h4>실행 정보</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>총 실행 시간:</strong> <span id="totalTime">0 ms</span></p>
                                    <p><strong>예상 비용:</strong> <span id="planCost">0</span></p>
                                </div>
                            </div>
                        </div>

                        <!-- 최적화 제안 -->
                        <div id="suggestionsSection" class="mt-4">
                            <h4>최적화 제안</h4>
                            <div id="suggestionsList"></div>
                        </div>

                        <!-- 노드 분석 -->
                        <div id="nodeAnalysisSection" class="mt-4">
                            <h4>실행 계획 노드별 분석</h4>
                            <div id="nodesList"></div>
                        </div>

                        <!-- 상세 분석 -->
                        <div id="detailsSection" class="mt-4">
                            <h4>상세 분석</h4>
                            <pre id="analysisDetails"></pre>
                        </div>

                        <!-- JSON 실행 계획 -->
                        <div id="jsonSection" class="mt-4">
                            <h4>JSON 실행 계획</h4>
                            <pre><code id="jsonPlan" class="language-json"></code></pre>
                        </div>
                    </div>

                    <div id="errorContainer" class="alert alert-danger" style="display: none;">
                        <h4>오류</h4>
                        <p id="errorMessage"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        document.getElementById('queryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const query = document.getElementById('sqlQuery').value.trim();
            if (!query) {
                alert('SQL 쿼리를 입력해주세요.');
                return;
            }

            // 로딩 상태 표시
            const loadingSpinner = document.querySelector('.loading');
            const submitButton = document.querySelector('button[type="submit"]');
            loadingSpinner.style.display = 'inline-block';
            submitButton.disabled = true;

            // 이전 결과 숨기기
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'none';

            // API 호출
            fetch('/api/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: query
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayResults(data);
                } else {
                    displayError(data.errorMessage);
                }
            })
            .catch(error => {
                displayError('네트워크 오류가 발생했습니다: ' + error.message);
            })
            .finally(() => {
                loadingSpinner.style.display = 'none';
                submitButton.disabled = false;
            });
        });

        function displayResults(data) {
            const resultContainer = document.getElementById('resultContainer');
            
            // 비용 정보 표시
            document.getElementById('cpuCost').textContent = '$' + data.resourceCost.cpuCost.toFixed(6);
            document.getElementById('ioCost').textContent = '$' + data.resourceCost.ioCost.toFixed(6);
            document.getElementById('memoryCost').textContent = '$' + data.resourceCost.memoryCost.toFixed(6);
            document.getElementById('totalCost').textContent = '$' + data.resourceCost.totalCost.toFixed(6);

            // 실행 정보 표시
            document.getElementById('totalTime').textContent = data.executionPlan.actualTotalTime.toFixed(2) + ' ms';
            document.getElementById('planCost').textContent = data.executionPlan.totalCost.toFixed(2);

            // 제안 사항 표시
            const suggestionsList = document.getElementById('suggestionsList');
            suggestionsList.innerHTML = '';
            if (data.suggestions && data.suggestions.length > 0) {
                data.suggestions.forEach(suggestion => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = suggestion;
                    suggestionsList.appendChild(div);
                });
            } else {
                suggestionsList.innerHTML = '<p>최적화 제안 사항이 없습니다.</p>';
            }

            // 노드 분석 표시
            const nodesList = document.getElementById('nodesList');
            nodesList.innerHTML = '';
            if (data.executionPlan.nodeAnalyses) {
                data.executionPlan.nodeAnalyses.forEach(node => {
                    const div = document.createElement('div');
                    div.className = 'node-analysis';
                    div.style.marginLeft = (node.depth * 20) + 'px';
                    div.innerHTML = `
                        <strong>${node.nodeType}</strong><br>
                        비용: ${node.totalCost ? node.totalCost.toFixed(2) : 'N/A'} | 
                        시간: ${node.actualTotalTime ? node.actualTotalTime.toFixed(2) : 'N/A'} ms | 
                        행수: ${node.actualRows || 'N/A'}
                        ${node.relationName ? '<br>테이블: ' + node.relationName : ''}
                    `;
                    nodesList.appendChild(div);
                });
            }

            // 상세 분석 표시
            document.getElementById('analysisDetails').textContent = data.resourceCost.analysisDetails || '상세 분석 정보가 없습니다.';

            // JSON 계획 표시
            const jsonPlan = document.getElementById('jsonPlan');
            jsonPlan.textContent = JSON.stringify(JSON.parse(data.executionPlan.jsonPlan), null, 2);

            // 결과 컨테이너 표시
            resultContainer.style.display = 'block';

            // 코드 하이라이팅 적용
            Prism.highlightAll();
        }

        function displayError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorContainer').style.display = 'block';
        }

        function clearResults() {
            document.getElementById('sqlQuery').value = '';
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'none';
        }
    </script>
</body>
</html>
